\documentclass[12pt,a4paper,twoside,openright,BCOR10mm,headsepline,titlepage,abstracton,chapterprefix,final]{scrreprt}


\RequirePackage{ifpdf}  % flag for pdf or dvi backend
\ifpdf
  \usepackage[pdftex]{graphicx}
  \usepackage[pdftitle={RTFM on Imaging Theory and Basics of Optical Raytracing},%
              pdfsubject={},%
              pdfauthor={},%
              pdfkeywords={},%
              bookmarks=true,%
%              colorlinks=true,%
              urlcolor=blue,%
              pdfpagelayout=TwoColumnRight,%
              pdfpagemode=UseNone,%
              pdfstartview=Fit,%
              pdftex]{hyperref}
\else
  \usepackage[dvips]{graphicx}
  \usepackage[colorlinks=false,dvips]{hyperref}
\fi
%\DeclareGraphicsRule{.jpg}{eps}{.jpg}{`convert #1 eps:-}

\usepackage{ae}
\usepackage[ngerman, english]{babel}

%\usepackage{SIunits}
\newcommand\elementarycharge{\textrm{e}}
\newcommand\sccm{\textrm{sccm}}
\newcommand\mbar{\milli\textrm{bar}}


\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{xcolor}
\usepackage{setspace}

%\widowpenalty = 1000


\newcommand*{\doi}[1]{\href{http://dx.doi.org/\detokenize{#1}}{doi: \detokenize{#1}}}






\newcommand\vacuum{0}

\newcommand\location{r}
\newcommand\Location{\Vector{r}}


\newcommand\wavenumber{k}
\newcommand\vacuumWavenumber{\wavenumber_{\vacuum}}
\newcommand\Wavevector{\Vector{\wavenumber}}

\newcommand\Vector[1]{\vec{#1}}
\newcommand\Nabla{\Vector{\nabla}}
\newcommand\Laplace{\Delta}
\newcommand\timederivative[1]{\dot{{#1}}}
\newcommand\Tensor[1]{\hat{#1}}
\newcommand\conjugate[1]{\overline{#1}}
\newcommand\transpose[1]{#1^{T}}
\newcommand\Norm[1]{\left| #1 \right|}
\newcommand{\ket}[1]{\left\vert{#1}\right\rangle}
\newcommand{\bra}[1]{\left\langle{#1}\right\vert}
\newcommand{\braket}[2]{\left\langle{#1}\vert{#2}\right\rangle}
\newcommand{\bracket}[1]{\left\langle{#1}\right\rangle}

\newcommand{\scpm}[2]{(#1\,\cdot\,#2)}

\newcommand\Greenfunction{\Tensor{G}}

\newcommand\scalarEfield{E}
\newcommand\scalarBfield{B}
\newcommand\scalarHfield{H}
\newcommand\scalarDfield{D}
\newcommand\scalarTipfield{T}
\newcommand\scalarSamplefield{S}
\newcommand\scalarDipolarmoment{p}
\newcommand\Efield{\Vector{\scalarEfield}}
\newcommand\Bfield{\Vector{\scalarBfield}}
\newcommand\Hfield{\Vector{\scalarHfield}}
\newcommand\Dfield{\Vector{\scalarDfield}}
\newcommand\Dipolarmoment{\Vector{\scalarDipolarmoment}}

\newcommand\permeability{\Tensor{\mu}}
\newcommand\vacuumpermeability{\mu_{\vacuum}}
\newcommand\permittivity{\Tensor{\epsilon}}
\newcommand\generalPermittivity{\Tensor{\tilde\epsilon}}
\newcommand\vacuumpermittivity{\epsilon_{\vacuum}}
\newcommand\scalarpermittivity{\epsilon}
\newcommand\conductivity{\Tensor{\sigma}}
\newcommand\susceptibility{\Tensor{\chi}}
\newcommand\currentdensity{\Vector{j}}
\newcommand\Current{\Vector{I}}
\newcommand\chargedensity{\rho}
\newcommand\PoyntingVector{\Vector{S}}

\newcommand{\remark}[1]{{\color{red}$\blacksquare$}\footnote{{\color{red}#1}}}

\begin{document}

\titlehead{ }
\subject{Pyrate -- Optical raytracing based on Python}
\title{Read This Fundamental Manual \\ on Imaging Theory and Basics of Optical Raytracing}
\author{}
\date{2014-2015}
\publishers{}
\maketitle

\onehalfspacing

\chapter{Optics from Maxwell Equations}
\section{The Source Free Maxwell Equations}
The content of this chapter is well known from textbooks \cite{Jackson}. Still, we repeat some of the equations to have a consistent nomeclature throughout this manual and the pyrate program
as well as a gain in clarity which aproximations are made.
We start from the Maxwell equations in SI units
\begin{subequations}\label{eq:Maxwell}
\begin{eqnarray}
  \Nabla \Dfield &=& \chargedensity 							\label{eq:MaxwellNablaD}\\
  \Nabla \times \Efield &=& - \timederivative{\Bfield}  					\label{eq:MaxwellNablaCrossE}\\
  \Nabla \Bfield &=& 0  									\label{eq:MaxwellNablaB}\\
  \Nabla \times \Hfield &=& \timederivative{\Dfield} + \currentdensity  		\label{eq:MaxwellNablaCrossH}
\end{eqnarray}
\end{subequations}
with the constitutive equations
\begin{subequations}\label{eq:Material}
\begin{eqnarray}
  \Dfield &=& \permittivity \Efield 								\label{eq:ConstitutiveEpsilon}\\
  \Bfield &=& \permeability \Hfield 								\label{eq:ConstitutiveMu}\\
  \currentdensity &=& \conductivity \Efield						\label{eq:ConstitutiveSigma}
\end{eqnarray}
\end{subequations}
and the continuity equation
\begin{eqnarray}
  \Nabla \currentdensity + \timederivative{\chargedensity} &=& 0		\label{eq:continuity}
\end{eqnarray}
All quantities are real valued.
All material properties are described by unit bearing quantities, i.e., they are \emph{not} measured relative to the vacuum values $\vacuumpermittivity$ and $\vacuumpermeability$. $\permittivity$ and $\permeability$ are the electric and magnetic permittivity, respectively, and $\conductivity$ the conductivity. 

We consider the strictly monochromatic case and introduce complex valued fields with the phase representing temporal retardation $\Efield,\Dfield,\Hfield,\Bfield \propto \exp(-i \omega t)$ for electrodynamic scenarios only, $\omega \neq 0$. 
Further we assume all materials are non-magnetic at the optical frequency $\omega$, that is $\permeability(\omega) = \vacuumpermeability$. 
Effects like the Magneto-Optical Kerr Effect (MOKE) stem from the deflection of oscillating electrons in a static (DC) magnetic field and are typically modeled by off-diagonal elements in the permittivity tensor, not the permeability.
\begin{subequations}
\begin{eqnarray}
  \Nabla \Dfield &=& \chargedensity 					\\
  \Nabla \times \Efield &=& i \omega \vacuumpermeability \Hfield	\\
  \Nabla \Hfield &=& 0  					\\
  \Nabla \times \Hfield &=& - i \omega \Dfield + \currentdensity  		
\end{eqnarray}
\end{subequations}

The physically measurable fields are $\Efield$ and $\Bfield$. All other fields are fictional fields introduced in the Maxwell model for ease of calculation.
To obtain the so-called source-free Maxwell equations, we replace some of them by newly defined quantities.
We introduce a \emph{new} permittivity
\begin{eqnarray}
  \permittivity_{new} = \permittivity - \frac{\conductivity}{i \omega}
\end{eqnarray}
Note that this newly defined permittivity is complex valued, where the imaginary part denotes electric conductivity and thus ohmic losses.
We introduce a corresponding \emph{new} $\Dfield$-field
\begin{eqnarray}
  \Dfield_{new} &=& \permittivity_{new} \Efield \\
  \Dfield &=& \Dfield_{new} + \frac{\conductivity}{i \omega} \Efield
\end{eqnarray}

In the Maxwell equations, we substitute the $\Dfield$-field by our newly defined field $\Dfield_{new}$.
With the conductivity equation \ref{eq:ConstitutiveSigma} and the continuity equation \ref{eq:continuity}, we find the so called source-free Maxwell equations
\begin{subequations}
\begin{eqnarray}
  \Nabla \Dfield_{new} &=& 0 					\\
  \Nabla \times \Efield &=& i \omega \vacuumpermeability \Hfield	\\
  \Nabla \Hfield &=& 0  					\\
  \Nabla \times \Hfield &=& - i \omega \Dfield_{new}  		
\end{eqnarray}
\end{subequations}
There are neither electric nor magnetic monopolar sources.
The equations are nearly symmetric in $\Dfield$ and $\Hfield$.
From now on, every time we write $\Dfield$, we mean the complex valued $\Dfield_{new}$ without explicitly writing the index \emph{new} (call us lazy, we don't care).
\begin{subequations}
\begin{eqnarray}
  \Nabla \Dfield &=& 0 					\\
  \Nabla \times \Efield &=& i \omega \vacuumpermeability \Hfield	\\
  \Nabla \Hfield &=& 0  					\\
  \Nabla \times \Hfield &=& - i \omega \Dfield  		
\end{eqnarray}
\label{eq:sourcefreemaxwell}
\end{subequations}

\section{Plane Wave Solutions and Dispersion}
\subsection{The general case}
We consider a homogeneous material $\permittivity(\Location) = const.$ We apply the Nabla curl operatur on the Maxwell curl equation for the electric field
\begin{eqnarray}
  \Nabla \times ( \Nabla \times \Efield ) &=& \Nabla \times ( i \omega \vacuumpermeability \Hfield ) 
  \\
  \nabla_i \nabla_i \scalarEfield_j - \nabla_i \nabla_j \scalarEfield_i &=& - \omega^2 \vacuumpermeability \permittivity_{jk} \scalarEfield_{k}
\end{eqnarray}
This is a differential equation with constant coefficients, so we use the ansatz
\begin{eqnarray}
 \Efield(\Location,\omega) &=& \Efield_0(\omega) \exp(i \Wavevector \Location)
\end{eqnarray}
where the $\Efield_0$ contains polarisation, electric field amplitude and harmonic time dependence. We find the eigenvalue equation

\begin{eqnarray}
\begin{pmatrix}
 \wavenumber_y^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{xx} 
 &
 - \wavenumber_x \wavenumber_y - \omega^2 \vacuumpermeability \scalarpermittivity_{xy}
 &
 - \wavenumber_x \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{xz}
 \\
 - \wavenumber_x \wavenumber_y - \omega^2 \vacuumpermeability \scalarpermittivity_{yx}
 &
 \wavenumber_x^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{yy} 
 &
 - \wavenumber_y \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{yz}
 \\
 - \wavenumber_x \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{zx}
 &
 - \wavenumber_y \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{zy}
 &
 \wavenumber_x^2 + \wavenumber_y^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{zz}  
\end{pmatrix}
\Efield
&=& 0
\end{eqnarray}
In general, each solution $\Wavevector$ is associated with a certain eigenvector direction $\Efield$,
that is, a propagation wavector is only valid for a certain polarisation.

\subsection{uniaxial anisotropic media}
to do

ordinary mode:
\begin{eqnarray}
 \wavenumber^2 &=& \omega^2 \vacuumpermeability \scalarpermittivity_{ord}
\end{eqnarray}
$\Efield$ is perpendicular on both the crystal optical axis and the propagation direction.

extraordinary mode:
\begin{eqnarray}
  \frac{\wavenumber_{ord}^2 }{\scalarpermittivity_{ex} } + \frac{\wavenumber_{ex}^2 }{\scalarpermittivity_{ord} } &=& \omega^2 \vacuumpermeability
\end{eqnarray}
$\Efield$ is in one plane with optical crystal axis and $\Wavevector$.


\subsection{isotropic media}

We use the result for uniaxial anisotropic materials and insert the same value for both ordinary and extraordinary permittivity $\scalarpermittivity_{ord} = \scalarpermittivity_{ex} = \scalarpermittivity$.
This results in a degenerate solution for both polarisations.
\begin{eqnarray}
 \Wavevector^2 &=& \omega^2 \vacuumpermeability \scalarpermittivity \\
 \Wavevector \Efield &=& 0
\end{eqnarray}
where $\Wavevector^2$ is not the absolute square, but the scalar product of the wavevector with itself.
We introduce the refractive index $n$ as
\begin{eqnarray}
 \Wavevector^2 &=& \omega^2 \vacuumpermeability \vacuumpermittivity n^2 \\
 n &=& \sqrt{ \frac{\scalarpermittivity}{\vacuumpermittivity} }
\end{eqnarray}
In general, there are two roots. 
The choice of the root does not change anything in optics based on the Maxwell equations, as the permittivity is the only physically relevant quantity.


\section{Boundary Conditions}
Considering two media $\permittivity_1$ and $\permittivity_2$, we find the following conditions fulfilled on the boundary in both media \cite{Jackson}:
\begin{subequations}
\begin{eqnarray}
 ( \Dfield_2 - \Dfield_1 ) \vec{n} &=& 0 \\
 ( \Bfield_2 - \Bfield_1 ) \vec{n} &=& 0 \\
 \vec{n} \times ( \Efield_2 - \Efield_1 ) &=& 0 \\
 \vec{n} \times ( \Hfield_2 - \Hfield_1 ) &=& 0 
\end{eqnarray}
\label{eq:boundary_conditions} 
\end{subequations}
These relations hold for a step-interface between two homogeneous media. 
In mesoscopically inhomogenous media like  diffractive optical elements and metamaterials, 
the boundary conditions hold at each interface between homogeneous materials of the mesoscopic sub-structure.


\section{Refraction of Plane Waves at Planar Surfaces}

\subsection{Derivation}
We consider a plane wave incident on a planar boundary between two homogeneous materials.
The incident plane wave projects a grating on the boundary plane. $\Dfield_1$ and $\Efield_1$ on the boundary in medium $\permittivity_1$ are modulated with the in-plane component of the wavevector. 
\begin{eqnarray}
 \Dfield_1, \Efield_1 &\propto& \exp( i \Wavevector_{1\parallel} \Location)|_{boundary} \\
 \Wavevector_{1\perp} &=& ( \Wavevector_1 \vec{n} ) \vec{n} \\
 \Wavevector_{1\parallel} &=& \Wavevector_1 - \Wavevector_{1\perp}
\end{eqnarray}
From the boundary conditions \ref{eq:boundary_conditions} we conclude that with $\Dfield_1$ and $\Efield_1$, also the fields $\Dfield_2$ and $\Efield_2$ in medium 2 are to be modulated by the same in-plane wavevector component.
\begin{eqnarray}
  \Dfield_2, \Efield_2 &\propto& \exp( i \Wavevector_{2\parallel} \Location)|_{boundary} \\
  \Wavevector_{2\parallel} &=& \Wavevector_{1\parallel}
\end{eqnarray}
From angular spectrum representation we conclude that the field in medium 2 is also a plane wave. 

\subsection{Results and Discussion}
Our formulation of the law of refraction is
\begin{eqnarray}
 \Efield_1(\Location) &=& \Efield_{01} \exp(i \Wavevector_1 \Location) \\
 \Efield_2(\Location) &=& \Efield_{02} \exp(i \Wavevector_2 \Location) \\
 \Wavevector_{2} &=& \Wavevector_{1\parallel} + \xi \vec{n}
\end{eqnarray}
This formulation holds for any planar boundary between two homogeneous media. The normal component of the wavevector in medium 2 depends on the material dispersion in material $\permittivity_2$.
Compared to the law of Snellius, this formulation bears the following advantages:
\begin{itemize}
 \item It does not require the calculation of angles in 3D space, only scalar products.
 \item The incident wavevector is a property of the ray. When calculating the refraction, the dispersion relation in material $\permittivity_1$ is not required.
 \item In object-oriented programming, we can introduce a class for refraction with objects isolated from adjacent ones.
 \item Unkline in the Snellius law, we can also calculate with complex valued permittivities and anisotropic permittivities.
\end{itemize}
The formulation does not actually solve the problem of refraction, but just forward it to the problem of finding a solution of the material dispersion. 
This calculation can, for certain types of anisotropic materials, be time consuming.

\section{Raytracing}
In raytracing, we assume that radiation is propagated in rays, that are thin, collimated beams. 
We assume that the rims of these beams are negligible compared to the central area. That is, rays act on surfaces like plane waves, and we neglect diffraction at the rims of the finite sized beams.
Further we assume that all rays are much smaller than the characteristic length of surface curvatures and all surfaces are locally approximated planar on the cross-section area of a ray.
Even in cases where the assumptions are not completely fulfilled, its accuracy compared to experiments is astonishing and lead to the great success of technical optics.
However, the optical designer has to check for each calculation whether the ray approximation is justified.

Classical raytracing consists of the following steps: The ray is considered a straight in 3D space. First its intersection point with the next surface is calculated. 
Then, a new wavevector is determined using the refraction law for plane waves on planar surfaces.

\subsection{Intersections of Straights with Spheres, Aspheres and Free-shapes}\label{subsec:intersectionformulas}
\subsubsection{Spheres}
We consider a ray and a Sphere that intersects the optical axis in the origin
\begin{eqnarray}
 \Location &=& \Location_0 + \vec{d} t \label{eq:ray}\,,\\
 \left| \Location - \begin{pmatrix} 0 \\ 0 \\ R \end{pmatrix} \right|^2 &=& R^2\,, \label{eq:sphereeq}
\end{eqnarray}
$\Location_0$ is the ray start point, $\vec{d}$ the ray direction unit vector and $t$ the free parameter of the straight.
The standard manner to derive the solution would be to insert the ray equation \eqref{eq:ray} into
\eqref{eq:sphereeq} and calculate the solutions for $t$ from the arising quadratic equation. This leads to a numerically unstable solution
for large radii $R$.
A solution numerically stable for the case of a planar surface $R \rightarrow \infty$ is:
\begin{subequations}
\label{eq:spheresolution}
\begin{eqnarray}
   F &=& d_z - \rho \scpm{\vec{d}}{\Location_0}\,, \\
   G &=& \rho |\Location_0|^2 - 2 z_0\,, \\
   H &=& - \rho\,, \\
   t &=& \frac{G}{ F + \sqrt{F^2 + H G} }\,, \label{eq:tsolsphere}
\end{eqnarray}
\end{subequations}
where $\rho = 1 / R$ is the surface curvature. 
The solution exists for positive terms under the square root only, $F^2 + H G > 0$. 
Otherwise, the ray misses the sphere.

The derivation of the former equations \eqref{eq:spheresolution} is not straight forward. Therefore we provide them for the reader in a stepwise manner.
If one rewrites the equation \eqref{eq:sphereeq} into components one gets
\begin{equation}
 z^2 - 2 z R = x^2 + y^2 \label{eq:quadraticimplicit}\,.
\end{equation}
This equation can be easily inverted for $z$ giving
\begin{equation}
 z = R \left(1\pm\sqrt{1 - \rho^2 (x^2 + y^2)}\right)\label{eq:solquadratic}\,,
\end{equation}
which is not the well-known form of the equation, yet.
The condition $z=0$ for $x=y=0$ fixes the solution branch to the one 
with the minus sign. Further the well-known form arises by multiplying 
$(1+ \sqrt{\dots})/(1+\sqrt{\dots})$ at the left hand side
of \eqref{eq:solquadratic} and expanding the numerator, which leads to
\begin{equation}
 z = \frac{\rho (x^2 + y^2)}{1 + \sqrt{1 - \rho^2 (x^2 + y^2)}} \label{eq:finalsagsphere}\,.
\end{equation}
Due to the former choice of the correct solution branch there are no
singularities occuring at $x=y=0$. Form \eqref{eq:finalsagsphere} of the 
sag equation is not well suited to calculate the intersection points. Therefore it is 
useful to go back to \eqref{eq:quadraticimplicit} and insert the ray \eqref{eq:ray}
into it in an invariant manner which leads to
\begin{equation}
 t^2 - 2 t \underbrace{\left(\frac{d_z}{\rho} - \scpm{\Location_0}{\vec{d}}\right)}_{F'} 
    - \underbrace{\left(\frac{2 z_0}{\rho} - |\Location_0|^2\right)}_{H' G'} = 0\,,\label{eq:teqsphere}
\end{equation}
where $H' = -1$ and $G' = |\Location_0|^2 - \tfrac{2 z_0}{\rho}$.
Solving this simple quadratic equation one gets
\begin{align}
 t &= F' \pm \sqrt{{F'}^2 + H' G'}\,.
\end{align}
Here the solution has still not the form \eqref{eq:tsolsphere} such that
we also multiply the left hand side by $(F' \mp \sqrt{\dots})/(F' \mp \sqrt{\dots})$.
Therefore we get
\begin{align}
 t &= \frac{\overbrace{-H'}^{=1} G'}{F' \mp \sqrt{{F'}^2 + H' G'}} = \frac{G'}{F' \mp \sqrt{{F'}^2 + H' G'}}\label{eq:tpresolutionsphere}\,.
\end{align}
To avoid singularities the plus branch of the solution is chosen and therefore the
form of the solution above turns into the one with the minus. Otherwise the $t$ would be
$t>0$ always. $F'$, $G'$ and $F$, $G$ can be converted into one another by
\begin{subequations}
\label{eq:fghscaling}
\begin{eqnarray}
 F &=& \rho F'\,,\\
 G &=& \rho G'\,,\\
 H &=& \rho H'\,.
\end{eqnarray}
\end{subequations}
An inspection of \eqref{eq:tpresolutionsphere} shows that it is invariant under scaling transformations \eqref{eq:fghscaling}
and therefore we may omit the primes and get \eqref{eq:tsolsphere}.


\subsubsection{Conics}
Conics are spheres, rotationally symmetric ellipsoids, paraboloids and hyperboloids.
The word ``conic" is short for conic section. This refers to these figures as the
intersections of a plane with a cone.
In the vertex form their surface sag $z$ can be described by
\begin{eqnarray}
 z =  \frac
 { \rho ( x^2 + y^2 ) }
 { 1 + \sqrt{1 - (1+c) \rho^2  (x^2 + y^2)} }\,,
\end{eqnarray}
where $c$ is the conic constant. Depending on this parameter, the conic is a
\begin{eqnarray*}
-1 < c < 0 && \textrm{oblate ellipsoid} \\
     c = 0 && \textrm{sphere} \\
 0 < c < 1 && \textrm{prolate ellipsoid} \\
     c = 1 && \textrm{paraboloid} \\
     c > 1 && \textrm{hyperboloid}
\end{eqnarray*}
As shown in the last section, for explicit calculation of the intersection parameter $t$ one
needs the implicit form of the surface equation
\begin{align}
 \rho (1 + c) z^2 - 2 z + \rho (x^2 + y^2) &=0\,.
\end{align}
After insertion of \eqref{eq:ray} and following a slightly generalized form of the calculation
given in sphere section the solution is
\begin{subequations}
\begin{eqnarray}
   F &=& d_z - \rho \left( d_x x_0 + d_y y_0 + d_z z_0 (1+c) \right)\,, \\
   G &=& \rho (x_0^2 + y_0^2 + z_0^2 (1+c)) - 2 z_0\,, \\
   H &=& - \rho ( 1 + c \, d_z^2 )\,, \\
   t &=& \frac{G}{ F + \sqrt{F^2 + H G}\,. }
\end{eqnarray}
\end{subequations}

\subsubsection{Biconics}
A biconic describes a surface which has two perpendicular sections
which have a conic structure. So these surfaces have two symmetry planes.
The explicit surface sag formula is given by
\begin{align}
 z &= \frac{\rho_x x^2 + \rho_y y^2}{1 + \sqrt{1 - (1+c_x) \rho_x^2 x^2 - (1+c_y) \rho_y^2 y^2}} \label{eq:biconic}\,.
\end{align}
The variables are $\rho_x = 1/R_x$ the $x$ curvature, $\rho_y = 1/R_y$ the $y$ curvature, $c_x$ the conic constant in $x$ direction,
and $c_y$ the conic constant in $y$ direction respectively. Setting $\rho_x = \rho_y = \rho$ and $c_x = c_y = c$ gives
the standard conic from the former section.

Unfortunately finding the invariant or implicit form of \eqref{eq:biconic} is not so easy. The simplest implicit form we found at least is given by
\begin{align}
 (a(x,y) - 1) z^2 + (z - b(x,y))^2 &= 0\,,\label{eq:implicitbiconic}
\end{align}
where $a(x,y) = (1 + c_x) \rho_x^2 x^2 + (1 + c_y) \rho_y^2 y^2$ and $b(x,y) = \rho_x x^2 + \rho_y y^2$. 
This leads to a fourth order equation after inserting \eqref{eq:ray}.
Such equations are in principle analytically solvable. But on the one hand it is very complicated and on the other hand 
it is not known whether there exists such a user-friendly numerically stable form of $t$ like in the former cases.\footnote{
In fact the word ``biconic" is misleading because it suggests that
it is a surface of second degree which is wrong. \eqref{eq:implicitbiconic}
shows clearly that it is a surface of degree four.}

Let us first assume that $\vec{r} = \vec{r}_0 + t \vec{d}$ is the insertion of the ray into
\eqref{eq:implicitbiconic}. Then $a(x(t), y(t)) =: Q_2(t)$ and $b(x(t), y(t)) =: Q_1(t)$ become quadratic polynomials 
in $t$. Further $z(t) =: L(t)$ becomes linear in $t$. Therefore this leads to
\begin{align}
 (Q_2(t) - 1) \underbrace{L^2(t)}_{\ge0} + \underbrace{(L(t) - Q_1(t))^2}_{\ge0} &= 0\,.\label{eq:biconict}
\end{align}
From \eqref{eq:biconic} and \eqref{eq:implicitbiconic} it follows that $1 - Q_2(t) \ge 0$ such that the
prefactor in \eqref{eq:biconict} is non-positive. Therefore the intersection equations lead to a real
fourth order polynomial which has to be solved. The quadratic polynomial $Q_2(t) - 1$ can be factorized
\begin{align}
 Q_2(t) - 1 &= A_2 (t - t_{Q21})(t - t_{Q22}) \le 0\,,
\end{align}
where $A_2 = (1 + c_x) \rho_x^2 d_x^2 + (1 + c_y) \rho_y^2 d_y^2$. If $A_2 > 0$ then at least one zero must exist and
$t \in [t_{Q21}, t_{Q22}]$. If $A_2 = 0$ then $Q_2(t)$ is not quadratic anymore. If $A_2 < 0$ then in 
\begin{align}
 Q_2(t) - 1 &= A_2 \left(\left(t-\frac{t_{Q21} + t_{Q22}}{2}\right)^2 - \frac{1}{4}(t_{Q21} - t_{Q22})^2\right)\,,
\end{align}
the expression in brackets has to be positive or zero. This is only true if the zeros are either the same or they are complex, because
for $t_{Q21/2} = \tau \pm i \sigma$ this expression becomes
\begin{align}
 Q_2(t) - 1 &= A_2 \left(\left(t-\tau\right)^2 + \frac{1}{2}\sigma^2\right)<0\,,
\end{align}
for real $t$. However the final equation is given by
\begin{align}
 a t^4 + b t^3 + c t^2 + d t + e &= 0\,,
\end{align}
where\remark{Coefficients as functions of biconics parameters!}
\begin{subequations}
 \begin{align}
  a &= \,,\\
  b &= \,,\\
  c &= \,,\\
  d &= \,,\\
  e &= \,.
 \end{align}
\end{subequations}
Then we may consider the nature of the zeros (see Wiki) by considering the following combinations, namely
the discriminant $\Delta$, the quadratic coefficient of the depressed quartic $P$, the linear coefficient of
the depressed quartic $Q$, $\Delta_0$ which is zero if the quartic has a triple root and $D$ which is zero
if the quartic has two double roots:
\begin{subequations}
 \begin{align}
  \Delta &= 256 a^3 e^3 - 192 a^2 b d e^2 - 128 a^2 c^2 e^2 + 144 a^2 c d^2 e - 27 a^2 d^4 \nonumber\\ 
&+ 144 a b^2 c e^2 - 6 a b^2 d^2 e - 80 a b c^2 d e + 18 a b c d^3 + 16 a c^4 e \nonumber\\
&- 4 a c^3 d^2 - 27 b^4 e^2 + 18 b^3 c d e - 4 b^3 d^3 - 4 b^2 c^3 e + b^2 c^2 d^2\,,\\
   P &= 8ac - 3b^2\,,\\
   Q &= b^3+8da^2-4abc\,,\\
   \Delta_0 &= c^2 - 3bd + 12ae\,,\\
   D &= 64 a^3 e - 16 a^2 c^2 + 16 a b^2 c - 16 a^2 bd - 3 b^4\,.
 \end{align}
\end{subequations}

\begin{itemize}
\item If $\Delta < 0$  then the equation has two real roots and two complex conjugate roots.
\item If $\Delta > 0$  then the equation's four roots are either all real or all complex.
\begin{itemize}
\item If $P < 0$ and $D < 0$ then all four roots are real and distinct.
\item If $P > 0$ or $D > 0$ then there are two pairs of complex conjugate roots.
\end{itemize}
\item If $\Delta = 0$  then either the polynomial has a multiple root, 
  or it is the square of a quadratic polynomial. Here are the different cases that can occur:
  \begin{itemize}
\item If $P < 0$ and $D < 0$ and $\Delta_0\ne0$, there is a real double root and two real simple roots.
\item If $D > 0$ or ($P > 0$ and ($D \ne 0$ or $Q \ne 0$)), there is a real double root and two complex conjugate roots.
\item If $\Delta_0 = 0$ and $D \ne 0$, there is a triple root and a simple root, all real.
\item If $D = 0$, then:
  \begin{itemize}
\item If $P < 0$, there are two real double roots.
\item If $P > 0$ and $Q = 0$, there are two complex conjugate double roots.
\item If $ \Delta_0  = 0$, all four roots are equal to $-\frac{b}{4a}$
  \end{itemize}
  \end{itemize}
\end{itemize}
Some of the discussed cases show that the ray misses the surfaces.

\subsubsection{Polynomial Asphere}
to do
\subsubsection{Strong Forbes Asphere}
to do
\subsubsection{Mild Forbes Asphere}
to do
\subsubsection{Cylindric}
to do
\subsubsection{Acylindric}
to do
\subsubsection{Free Shapes}
to do

\subsubsection{Linear Combinations}
\remark{I would suggest to implement a few standard forms and to combine them by a linear combination operator. This makes the search for optimizable
variables more difficult.}
\subsection{Intersections in nonlinear XYUV formalism}
According to {{\tt \url{http://graphics.stanford.edu/courses/cs148-10-summer/docs/2006--degreve--reflection_refraction.pdf}}}
we will call the incident vector $\vec{i}$ the reflected one $\vec{r}$ and the refracted one $\vec{t}$.
From reflection law we get the following ($\vec{n}$ is pointing into medium $n_1$ and the incidence vector is pointing from $n_1$ to $n_2$)
\begin{align}
 \vec{r} &= \vec{i} - 2 \scpm{\vec{i}}{\vec{n}} \vec{n}\,.\label{eq:reflection_vector}
\end{align}
From refraction we get\remark{I know that is not as elegant as the former 
solution by considering the field components at material boundaries :-)}
\begin{align}
 \vec{t} &= \frac{n_1}{n_2} \vec{i} 
 + \left[\frac{n_1}{n_2} \scpm{\vec{i}}{\vec{n}} 
      - \sqrt{1 - \left(\frac{n_1}{n_2}\right)^2 (1 - {\scpm{\vec{i}}{\vec{n}}}^2)}\right] \vec{n}\,.\label{eq:refraction_vector}
\end{align}
Let us now consider the optical axis $\vec{e}_z$ and some starting point of the ray at distance $d_1$ at the left hand side
of the optical surface $F(x, y)$, $\vec{X} = (x,y,-d_1)$,. The direction vector is given by $\vec{d} = (d_x, d_y, \sqrt{1 - d_x^2 - d_y^2})$
The components of the direction vector are equivalent to some aiming angles. For our convenience at the moment we take our
four variables $(x, y, d_x, d_y)$ as free starting parameters and try to calculate the new parameters at distance $d_2$ behind the
optical surface $F(x, y)$, $(x', y', {d_x}', {d_y}')$, via some nonlinear transform $(x', y', {d_x}', {d_y}') = T(x, y, d_x, d_y)$,
where $T$ is some function $T:\mathbb{R}^4 \to \mathbb{R}^4$.

By using the formulas from \ref{subsec:intersectionformulas} it is possible to invert the equation 
$z - t d_1 = F(x + t d_x, y + t d_y)$ for $t$ either analytically or numerically. The equation tells
us where the ray started at $z = -d_1$ and $x, y$ intersects the surface $F(x, y)$. Let the solution
of this equation $t_\text{intersect} = \sigma(x, y, d_x, d_y)$. (Notice that the function $\sigma$
is in general nonlinear in its arguments, even for the simplest case of a sphere.) Then by using the 
sigma notation the intersection point is also given by a nonlinear vector entity:
\begin{align}
 \vec{p}_\text{i} &= \begin{pmatrix} x + \sigma(x,y,d_x,d_y) d_x \\ y + \sigma(x,y,d_x,d_y) d_y \\ -d_1 + \sigma(x,y,d_x,d_y) \sqrt{1 - d_x^2 - d_y^2} \end{pmatrix}\,.\label{eq:pintersect}
\end{align}
The vector perpendicular on the surface pointing in direction of medium $n_1$ (left hand side, negative $z$ direction) is given
by
\begin{align}
 \vec{n}(x, y) &= 
  \frac{1}{\sqrt{1 + (\vec{\nabla}_{x,y} F)^2}} 
  \begin{pmatrix} \frac{\partial F}{\partial y} \\ \frac{\partial F}{\partial y} \\ -1 \end{pmatrix}\,.\label{eq:surfacenormal}
\end{align}
This direction vector has to be evaluated at $\vec{p}_\text{i}$ to get the appropriate results for
the transmission and reflection direction. Now we may use \eqref{eq:refraction_vector} or \eqref{eq:reflection_vector}
and \eqref{eq:surfacenormal} evaluated at \eqref{eq:pintersect} to calculate the direction vector $\vec{d}'(p_{\text{i} x}, p_{\text{i} y})$.
To calculate $x'$ and $y'$ we have to calculate another ray which starts at $p_\text{intersect}$ and ends at the
distance $d_2$ from the plane. Therefore $\vec{p}_{\text{intersect}\,z} + t_\text{new} \sqrt{1 - {d'}_x^2 - {d'}_y^2} = d_2$ and so
\begin{align}
t_\text{new} &= \frac{d_2 - p_{\text{i}\,z}}{\sqrt{1 - {d'}_x^2 - {d'}_y^2}}\,.
\end{align}
Thus the final coordinates are given by
\begin{subequations}
\begin{align}
 x' &= p_{\text{i}\,x} + \frac{d_2 - p_{\text{i}\,z}}{\sqrt{1 - {d'}_x^2 - {d'}_y^2}} {d'}_x\,,\\
 y' &= p_{\text{i}\,y} + \frac{d_2 - p_{\text{i}\,z}}{\sqrt{1 - {d'}_x^2 - {d'}_y^2}} {d'}_y\,.
\end{align}
\end{subequations}





\end{document}
